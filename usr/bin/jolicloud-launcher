#!/usr/bin/perl

use LWP;
use Logger::Syslog;

$| = 1;
$0 = "jolicloud-launcher [main]";

my $ONLINE_URL = "http://my.jolicloud.com";
my $OFFLINE_URL = "file:///usr/share/jolicloud-daemon/htdocs/index.html";

my @children;

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    close( STDOUT );
    close( STDERR );
    $0 = "jolicloud-launcher [jolicloud-daemon]";
    logger_prefix("jolicloud-daemon");
    for ( ;; ) {
        if ( `pgrep -fl ^jolicloud-daemon` ) {
            sleep( 5 );
            next;
        }
        notice( "launching" );
        system( "/usr/bin/jolicloud-daemon" );
        if ( $? == -1 ) {
            error( "failed to execute: $!" );
        }
        else {
            error( "child exited with value " . ( $? >> 8 ) );
        }
    }
    exit;
}

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    my $ua = LWP::UserAgent->new();
    close( STDOUT );
    close( STDERR );
    $0 = "jolicloud-launcher [nickel-browser]";
    logger_prefix("nickel-browser");
    for ( ;; ) {
        if ( `pgrep -fl nickel-browser | grep '\\-\\-desktop'` ) {
            sleep( 5 );
            next;
        }

        notice( "launching" );

        # Do a generic ping of the ping URL. If it responds with error
        # status 400: NOT_LOGGED_IN we know we have internet access to the
        # jolicloud server.
        my $req = HTTP::Request->new( GET => "$ONLINE_URL/api/ping" );
        my $res = $ua->request( $req );
        my $url = $ONLINE_URL;
        unless ( $res->code eq 400 &&
             $res->content eq '{"error":{"code":"NOT_LOGGED_IN"}}' ) {
            # No internet access, display the internal offline URL.
            $url = $OFFLINE_URL;
        }

        system( "/usr/bin/nickel-browser", "--app=$url", "--desktop",
                "--no-default-browser-check",
                "--no-first-run", "--enable-ipv6" );
        if ( $? == -1 ) {
            error( "failed to execute: $!" );
        }
        else {
            error( "child exited with value " . ( $? >> 8 ) );
        }
    }
    exit;
}


# If something happens to the main program, kill all the looping children

$SIG{ 'INT' } = \&reaper;
$SIG{ 'TERM' } = \&reaper;
$SIG{ 'KILL' } = \&reaper;
$SIG{ 'HUP' } = 'IGNORE';

foreach ( @children ) {
    waitpid( $_, 0 );
}


sub reaper
{
    notice( "killing: " . join( ', ', @children ) );
    kill( 'TERM', @children );
}
